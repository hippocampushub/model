"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4420],{54420:function(e,t,s){s.r(t),s.d(t,{default:function(){return volume_viewer_VolumeViewer}});var i=s(85893),r=s(67294),n=s(2801),o=s(83848),a=s(73265),l=s(35741),h=s(26401),c=s(65400),d=s(31059),u=s(1825),m=s(94055),v=s(61267),p=s(23493),C=s.n(p),w=s(79753),x=s(87011),g=s(99477);let RendererCtrl=class RendererCtrl{get render(){if(this.stopped)return!1;if(this.countinuousRenderCounter)return!0;if(this.stopTime){let e=Date.now();return this.stopTime>e||(this.stopTime=null,!1)}let{once:e}=this;return this.once=!1,e}renderOnce(){this.once=!0}renderFor(e){let t=Date.now();this.stopTime&&this.stopTime>t+e||(this.stopTime=t+e)}renderUntilStopped(){return this.countinuousRenderCounter+=1,()=>{this.countinuousRenderCounter-=1}}stop(){this.stopped=!0}constructor(){this.stopped=!1,this.countinuousRenderCounter=0,this.once=!0,this.stopTime=null}};var b=s(93162);let f={REGION:"#888888",SLM:"#ff0000",SR:"#87cefa",SP:"#0000ff",SO:"#00ff00"};function parseCssColor(e){return parseInt(e.replace("#",""),16)}let VolumeViewer=class VolumeViewer{async init(e,t){this.meshPath=e,this.volumeSection=t,this.initCanvas(),this.initRenderer(),this.initScene(),this.initCamera(),this.initControls(),this.initEvents(),this.initObservers(),this.initMaterials(),await this.initMeshes(),this.alignCamera(),this.startRenderLoop(),this.ctrl.renderOnce()}resize(){let{clientWidth:e,clientHeight:t}=this.container;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.ctrl.renderOnce()}setVolumeSection(e,t){this.volumeSection=e,Object.entries(this.layerMesh).forEach(s=>{let[i,r]=s,[,n,o]=i.match(/(\w+)\_(\w+)/);r.visible=n===e&&t[o]}),this.regionMesh&&(this.regionMesh.visible=this.regionMeshVisible&&this.canRenderRegionMesh()),this.ctrl.renderOnce()}setRegionMaskVisibility(e){this.regionMeshVisible=e,this.regionMesh&&(this.regionMesh.visible=e&&this.canRenderRegionMesh()),this.ctrl.renderOnce()}setLayerVisibility(e){Object.entries(e).forEach(e=>{let[t,s]=e,i="".concat(this.volumeSection,"_").concat(t);if(!this.layerMesh[i])throw Error("Mesh for ".concat(i," is not found"));this.layerMesh[i].visible=s}),this.ctrl.renderOnce()}downloadRender(e){let{clientWidth:t,clientHeight:s}=this.renderer.domElement.parentElement,i=new g.CP7({antialias:!0,alpha:!0,preserveDrawingBuffer:!0,physicallyCorrectColors:!0});i.setSize(3*t,3*s),i.render(this.scene,this.camera),i.domElement.toBlob(t=>(0,b.saveAs)(t,"".concat(e,".png"))),i.dispose()}destroy(){Object.values(this.material).forEach(e=>e.dispose()),Object.values(this.layerMesh).forEach(e=>e.geometry.dispose()),this.regionMesh&&this.regionMesh.geometry.dispose(),this.renderer&&(this.renderer.domElement.removeEventListener("wheel",this.onUserInteract),this.renderer.domElement.removeEventListener("mousemove",this.onUserInteract),this.renderer.domElement.removeEventListener("touchmove",this.onUserInteract),this.renderer.domElement.removeEventListener("pointermove",this.onUserInteract)),this.resizeObserver&&this.resizeObserver.unobserve(this.container),this.controls&&this.controls.dispose(),this.renderer&&this.renderer.dispose(),this.container&&this.canvas&&this.container.removeChild(this.canvas)}initCanvas(){this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas)}initRenderer(){this.renderer=new g.CP7({canvas:this.canvas,antialias:!0});let{clientWidth:e,clientHeight:t}=this.container;this.renderer.setSize(e,t),this.renderer.setPixelRatio(window.devicePixelRatio||1)}initScene(){this.scene=new g.xsS,this.scene.background=new g.Ilk(16711163),this.scene.add(new g.Mig(5592405))}initCamera(){let{clientWidth:e,clientHeight:t}=this.container;this.camera=new g.cPb(45,e/t,1,3e4),this.scene.add(this.camera),this.camera.add(new g.cek(13290186,.9))}initControls(){this.controls=new w.$(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.zoomSpeed=.5,this.controls.rotateSpeed=.8,this.controls.maxDistance=2e4}initEvents(){let e={capture:!1,passive:!0};this.onUserInteract=C()(()=>this.ctrl.renderFor(4e3),100).bind(this),this.canvas.addEventListener("wheel",this.onUserInteract,e),this.canvas.addEventListener("mousemove",this.onUserInteract,e),this.canvas.addEventListener("touchmove",this.onUserInteract,e),this.canvas.addEventListener("pointermove",this.onUserInteract,e)}initObservers(){this.resizeObserver=new ResizeObserver(()=>setTimeout(()=>this.resize(),0)),this.resizeObserver.observe(this.container)}initMaterials(){this.material={REGION:new g.YBo({color:parseCssColor(f.REGION),wireframe:!0,transparent:!0,opacity:.1}),SLM:new g.YBo({color:parseCssColor(f.SLM),side:g.ehD}),SR:new g.YBo({color:parseCssColor(f.SR),side:g.ehD}),SP:new g.YBo({color:parseCssColor(f.SP),side:g.ehD}),SO:new g.YBo({color:parseCssColor(f.SO),side:g.ehD})}}initMeshes(){let e=new x.L;return new Promise(t=>{e.load(this.meshPath,e=>{e.traverse(e=>{if(!e.isMesh)return;let{name:t}=e;if("region"===t){let t=this.material.REGION;e.material=t,e.visible=this.canRenderRegionMesh(),this.regionMesh=e}else{let[,s,i]=t.match(/(\w+)_(\w+)/),r=this.material[i];e.material=r,e.visible=s===this.volumeSection,this.layerMesh["".concat(s,"_").concat(i)]=e}}),this.scene.add(e),this.group=e,t()})})}alignCamera(){let e=new g.ZzF().setFromObject(this.group),t=new g.Pa4;e.getCenter(t);let s=new g.Pa4;e.getSize(s);let i=s.x;this.camera.position.z=t.z,this.camera.position.y=t.y;let r=i/Math.tan(Math.PI*this.camera.fov/360)*1.15;this.camera.position.x=t.x-r,this.controls.target=t,this.controls.update()}startRenderLoop(){this.ctrl.stopped||(this.ctrl.render&&(this.controls.update(),this.renderer.render(this.scene,this.camera)),requestAnimationFrame(this.startRenderLoop.bind(this)))}canRenderRegionMesh(){return"region"!==this.volumeSection}constructor(e){this.meshPath=null,this.volumeSection=null,this.container=null,this.resizeObserver=null,this.canvas=null,this.renderer=null,this.scene=null,this.camera=null,this.controls=null,this.ctrl=new RendererCtrl,this.onUserInteract=()=>{},this.material={},this.regionMesh=null,this.group=null,this.layerMesh={},this.regionMeshVisible=!0,this.container=e}};var S=s(2064),R=s.n(S);let ColoredBox=e=>{let{cssColor:t}=e;return(0,i.jsx)("div",{className:R().coloredBox,style:{"--box-color":t}})};var volume_viewer_Legend=()=>(0,i.jsxs)("div",{className:R().legend,children:[(0,i.jsxs)("div",{children:[(0,i.jsx)(ColoredBox,{cssColor:f.SLM})," SLM"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)(ColoredBox,{cssColor:f.SR})," SR"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)(ColoredBox,{cssColor:f.SP})," SP"]}),(0,i.jsxs)("div",{children:[(0,i.jsx)(ColoredBox,{cssColor:f.SO})," SO"]})]});let M={SLM:!0,SR:!0,SP:!0,SO:!0},j=document.fullscreenEnabled||document.webkitFullscreenEnabled;var volume_viewer_VolumeViewer=e=>{let{meshPath:t,volumeSection:s,onReady:p}=e,C=(0,r.useRef)(null),[w,x]=(0,r.useState)(null),[g,b]=(0,r.useState)(!1),S=(0,n.r)(),[E,y]=(0,r.useState)(M),[O,L]=(0,r.useState)(!0),updateLayerVisibility=e=>{y(e),null==w||w.setLayerVisibility(e)},updateRegionMaskVisibility=e=>{L(e),null==w||w.setRegionMaskVisibility(e)};return(0,r.useEffect)(()=>{if(!t||!C.current)return;let e=C.current,i=new VolumeViewer(e);return x(i),i.init(t,s).then(()=>{p&&p()}),()=>{i.destroy()}},[t,C,s,p]),(0,r.useEffect)(()=>{w&&s&&w.setVolumeSection(s,E)},[w,s,E]),(0,i.jsx)("div",{children:(0,i.jsx)(n.I,{className:S.active?void 0:R().fixedAspectRatio,handle:S,children:(0,i.jsxs)("div",{className:R().container,ref:C,children:[(0,i.jsx)(m.default,{title:"Viewer settings",children:(0,i.jsx)(c.default,{className:R().settingBtn,size:"small",onClick:()=>b(!0),icon:(0,i.jsx)(l.Z,{})})}),(0,i.jsxs)("div",{className:R().topRightCtrlGroup,children:[(0,i.jsx)(m.default,{title:"Download render as a PNG",children:(0,i.jsx)(c.default,{size:"small",onClick:()=>{let e="volume_render_CA1_".concat(s);null==w||w.downloadRender(e)},icon:(0,i.jsx)(h.Z,{})})}),j&&(0,i.jsx)(m.default,{title:"Fullscreen",children:(0,i.jsx)(c.default,{size:"small",className:"ml-1",onClick:()=>{S.active?S.exit():S.enter()},icon:S.active?(0,i.jsx)(a.Z,{}):(0,i.jsx)(o.Z,{})})})]}),(0,i.jsx)(volume_viewer_Legend,{}),(0,i.jsxs)(u.Z,{title:"Viewer settings",placement:"left",closable:!0,width:240,onClose:()=>b(!1),open:g,getContainer:!1,style:{position:"absolute"},children:[(0,i.jsx)("div",{children:(0,i.jsx)(d.default,{className:R().coloredCheckbox,style:{"--checkbox-color":f.REGION},defaultChecked:O,onChange:e=>{let{checked:t}=e.target;updateRegionMaskVisibility(t)},children:"CA1 region mask"})}),(0,i.jsx)("h4",{className:"mt-2",children:"Layers"}),v.ug.map(e=>(0,i.jsx)("div",{className:"mt-1",children:(0,i.jsx)(d.default,{className:R().coloredCheckbox,style:{"--checkbox-color":f[e]},defaultChecked:E[e],onChange:t=>{let{checked:s}=t.target;updateLayerVisibility({...E,[e]:s})},children:e})},e))]})]})})})}}}]);